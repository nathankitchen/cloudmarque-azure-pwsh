component: metricAlerts

service:
  dependencies:
    actionGroups: [Core-Test-Ag1]
    resourceGroup: Core-Test-Monitor-Rg
  publish:
    metricAlert: Mon-Test-Ma

groups:
- name: VMStandard
  alertSets:
  - name:                                                                             # Optional - It is recommended to use name when using multiple sets of alerts.
    resourceType: Microsoft.Compute/virtualMachines
    alerts:
    - name: Used-OSDskBurst-Wrn                                                   # Optional - It is recommended to use name for more understandable alert names.
      metricName: OS Disk Used Burst BPS Credits Percentage
      targetResourceLocation: East US
      severity: Warning
      threshold:
        operator: GreaterThanOrEqual
        value: 85
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-OSDskBurst-Crt
      metricName: OS Disk Used Burst BPS Credits Percentage
      targetResourceLocation: East US
      severity: Critical
      threshold:
        operator: GreaterThanOrEqual
        value: 95
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-DataDskBurst-Wrn
      metricName: Data Disk Used Burst BPS Credits Percentage
      targetResourceLocation: East US
      severity: Warning
      threshold:
        operator: GreaterThanOrEqual
        value: 85
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-DataDskBurst-Crt
      metricName: Data Disk Used Burst BPS Credits Percentage
      targetResourceLocation: East US
      severity: Critical
      threshold:
        operator: GreaterThanOrEqual
        value: 95
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-OSDskIops-Wrn
      metricName: OS Disk IOPS Consumed Percentage
      targetResourceLocation: East US
      severity: Warning
      threshold:
        operator: GreaterThanOrEqual
        value: 95
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-OSDskIops-Crt
      metricName: OS Disk IOPS Consumed Percentage
      targetResourceLocation: East US
      severity: Critical
      threshold:
        operator: Equals
        value: 100
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-DataDskIops-Wrn
      metricName: Data Disk IOPS Consumed Percentage
      targetResourceLocation: East US
      severity: Warning
      threshold:
        operator: GreaterThanOrEqual
        value: 95
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

    - name: Used-DataDskIops-Crt
      metricName: Data Disk IOPS Consumed Percentage
      targetResourceLocation: East US
      severity: Critical
      threshold:
        operator: Equals
        value: 100
        timeAggregation: Average
      service:
        dependencies:
          actionGroups: [Core-Test-Ag1]
          targetResourceGroups: [Iaas-Test-Vm-Rg2]
        publish:
          metricAlert: Mon-Test-Ma1
      schedule:
        frequencyInMinutes: 15                                # evaluationFrequency
        timeWindowInMinutes: 60                               # windowSize

  # - name: VMStandard-rg
  #   alertSets:
  #   - resourceType: Microsoft.Compute/virtualMachines
  #     alerts:
  #     - metricName: CPU Credits Remaining
  #       location: UK South
  #       severity: Critical
  #       threshold:
  #         operator: GreaterThan
  #         value: 0
  #         timeAggregation: Average
  #       service:
  #         dependencies:
  #           targetResources:
  #             - Iaas-Test-VmX
  #       schedule:
  #         frequencyInMinutes: 1                                # evaluationFrequency
  #         timeWindowInMinutes: 5                               # windowSize


# Notes:
# 1. Refer to https://docs.microsoft.com/en-us/azure/azure-monitor/essentials/metrics-supported
# 2. Multi-resource metric alert rules are only available for multiple resources in the same location.
